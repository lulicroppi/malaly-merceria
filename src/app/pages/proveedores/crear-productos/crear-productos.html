<section class="wrap">
  <div class="backrow">
    <button class="btn btn--sec btn--sm" (click)="volverPaso1()">← Volver</button>
  </div>

  <h1 class="title">Nuevo Proveedor — Productos</h1>

  <!-- Form alta/edición -->
  <form class="panel form" [formGroup]="form" (ngSubmit)="addOrUpdate()" novalidate>
    <div class="grid">
      <label class="field">
        <span>Producto *</span>
        <input type="text" formControlName="nombre_base" placeholder="Ej.: Hilo de algodón">
        <small class="err" *ngIf="form.get('nombre_base')?.touched && form.get('nombre_base')?.hasError('required')">
          El <b>Producto</b> es obligatorio.
        </small>
      </label>

      <label class="field">
        <span>Variante</span>
        <input type="text" formControlName="variante" placeholder="Ej.: Azul 2mm">
      </label>

      <label class="field">
        <span>Unidad de compra *</span>
        <input type="text" formControlName="unidad_compra" placeholder="Ej.: rollo, bolsa">
        <small class="err" *ngIf="form.get('unidad_compra')?.touched && form.get('unidad_compra')?.hasError('required')">
          La <b>unidad de compra</b> es obligatoria.
        </small>
      </label>

      <label class="field">
        <span>Cant. por unidad de compra *</span>
        <input type="number" step="0.0001" formControlName="cant_por_unidad_compra" placeholder="Ej.: 100">
        <small class="err" *ngIf="form.get('cant_por_unidad_compra')?.touched && form.get('cant_por_unidad_compra')?.errors">
          Debe ser un número &gt; 0.
        </small>
      </label>

      <label class="field">
        <span>Precio del proveedor (por unidad de compra) *</span>
        <input type="number" step="0.01" formControlName="precio_compra" placeholder="Ej.: 5000">
        <small class="err" *ngIf="form.get('precio_compra')?.touched && form.get('precio_compra')?.errors">
          Debe ser un número ≥ 0.
        </small>
      </label>

      <label class="field">
        <span>Unidad de venta *</span>
        <input type="text" formControlName="unidad_venta" placeholder="Ej.: metro, unidad">
        <small class="err" *ngIf="form.get('unidad_venta')?.touched && form.get('unidad_venta')?.hasError('required')">
          La <b>unidad de venta</b> es obligatoria.
        </small>
      </label>

      <div class="field field--row">
        <label><input type="checkbox" formControlName="permite_fraccion"> Permitir fraccionadas</label>
        <label><input type="checkbox" formControlName="permite_entero" checked> Permitir vender como “Entero”</label>
      </div>

      <!-- Previews -->
      <div class="preview">
        <div>Precio proveedor por <b>unidad de venta</b>: <strong>${{ precioPorUnidadVenta | number:'1.2-2' }}</strong></div>
        <div>Precio proveedor del <b>“Entero”</b>: <strong>${{ precioEntero | number:'1.2-2' }}</strong></div>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="btn btn--sec" (click)="cancelar()">Cancelar</button>
      <button type="submit" class="btn">{{ editIndex >= 0 ? 'Guardar cambios' : 'Agregar producto' }}</button>
    </div>
  </form>

  <!-- Tabla de items -->
  <div class="panel table" *ngIf="items.length; else empty">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Variante</th>
          <th>Compra</th>
          <th>Precio compra</th>
          <th>→ por venta</th>
          <th>Venta</th>
          <th>Fracc.</th>
          <th>Entero</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let it of items; let i = index">
          <td>{{ it.nombre_base }}</td>
          <td>{{ it.variante || '-' }}</td>
          <td>{{ it.cant_por_unidad_compra }} x {{ it.unidad_compra }}</td>
          <td>${{ it.precio_compra | number:'1.2-2' }}</td>
          <td>${{ precioUnidadVenta(it) | number:'1.2-2' }}</td>
          <td>{{ it.unidad_venta }}</td>
          <td>{{ it.permite_fraccion ? 'Sí' : 'No' }}</td>
          <td>{{ it.permite_entero ? 'Sí' : 'No' }}</td>
          <td class="actions">
            <button class="btn btn--sm" (click)="edit(i)">Editar</button>
            <button class="btn btn--sm btn--danger" (click)="remove(i)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #empty>
    <div class="panel" style="text-align:center; padding:16px;">Agregá al menos un producto.</div>
  </ng-template>

  <div class="footer-actions">
    <button class="btn btn--sec" (click)="volverPaso1()">Volver</button>
    <button class="btn" (click)="guardarProveedor()">Guardar proveedor</button>
  </div>

  <!-- Diálogo duplicado -->
  <div class="dup" *ngIf="dupOpen">
    <div class="dup__card">
      <h3>Producto duplicado</h3>
      <p>Ese producto ya está en la lista. ¿Qué querés hacer?</p>
      <div class="dup__actions">
        <button class="btn" (click)="dupActualizarPrecio()">Actualizar precio</button>
        <button class="btn btn--sec" (click)="dupCancelar()">Cancelar</button>
        <button class="btn" (click)="dupEsVarianteDistinta()">Es una variante distinta</button>
      </div>
    </div>
  </div>
</section>